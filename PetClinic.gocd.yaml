format_version: 9
environments:
  gcp:
    environment_variables:
      GCLOUD_CLUSTER: devops-workshop-gke
      GCLOUD_ZONE: us-central1-a
      GCLOUD_PROJECT_ID: devops-workshop-123
    secure_variables:
      GCLOUD_SERVICE_KEY: AES:O2Ux7rRKuqJmIo1yHeWx0w==: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
    pipelines:
      - PetClinic
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: devops-west-20
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
            elastic_profile_id: docker-jdk
            artifacts:
              - test:
                  source: target/surefire-reports
                  destination: test-reports
            tasks:
            - exec:
                arguments:
                - clean
                - package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - secret.json
                command: rm
                run_if: passed
