format_version: 9
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: devops-west-20
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
              GCLOUD_PROJECT_ID: devops-workshop-123
            secure_variables:
              GCLOUD_SERVICE_KEY: AES:O2Ux7rRKuqJmIo1yHeWx0w==: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
            elastic_profile_id: docker-jdk
            tasks:
            - exec:
                arguments:
                - clean
                - package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          deploy:
            timeout: 0
            environment_variables:
              GCLOUD_CLUSTER: devops-workshop-gke
              GCLOUD_ZONE: us-central1-a
              GCLOUD_PROJECT_ID: devops-workshop-123
            secure_variables:
              GCLOUD_SERVICE_KEY: AES:Re0+EWNUhqg781Bh7M3QBA==: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
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - secret.json
                command: rm
                run_if: passed
