format_version: 9
environments:
  gcp:
    environment_variables:
      GCLOUD_CLUSTER: devops-workshop-gke
      GCLOUD_ZONE: us-central1-a
      GCLOUD_PROJECT_ID: devops-workshop-123
    secure_variables:
      GCLOUD_SERVICE_KEY: AES:SkopuEwlTgypJ8zffEe3+w==:ZaC9Old08Q7BCKZSMqPGjygLErAInT+ra0omcrxXyOvAq62EGtpa/4kQShl0u2vxIRjITUCXXXCg/Tllr5WAi2KRms88nAjyPXqtO1y71CrLdGJ7uzQwtli0CzXGhTyM4PC0us5voYa22sedYelDJlIBwwzSa+2UBRjEpzJlSV4Mpxk76OtQPhQuJrFtyh/NXqwunhoitshrO4gInZUEuUMQjtoGrGBqNeQaPFxAIEVwxKDP6JpWtDe6IXFfHLUXDjo7IQE0ueKGY01vOB9YBljupXkSQNqRQHIU5nxPgL3cbKV+0EC8VlUXeTVZQsaRVTeUPkUuLOgrE/RPwHfZsfwaj/o4ruK4L0EzU5m8p1VyZ9vlp5W4QcohVrbxKRLblUqr3VXROFgJMaDbP2CPlEz48S6HKaT5mC6L7rV7qtP3bdLm8DKmufHpQisBm+RgRlLI9s4TVf/UbD3B+HY/sa1vr/ITeL3FSz0MeYJUHZ7lsZ95IDn88O1hounsG8mu3AiPnGm5olHyvOBpxS0FdhJ3tDahEd7BEBDNfpLxyI8p+aH6bWXqlnVkJ6bWBrjpX95qDJVtw6mMPnwWZIVfxR2EuXUcJTfoFhqZYjPpxM3itLW4nFJm8rbSG48aQPfXpG+FIbBDy93vzcm8uht3HM73joIlbhsc1tc3ZMLAeXxSoQVXb7vRmQxkP2oWtrLiCyFHBgWbHSID+cBrkNohlMMfn7XOf0z/5fy3i2/9MqHMqHangIXZUiI1tOS+Q3y0dLw8oTmaYK3j+9FwkOkTauiWZFJfwwd1LyRlhQyoxSwMeV9SuKJCpwO1U1l2027ROhHTho3Iqz5NRM8YHTPs2X/HopDJ71rYCZV7umWpdrAYYpHbE+Wj9yyCLPiY/QySr2xHk/eXFeEyXfI1j/vtsu7eZVp13vcB6yXJYUIcmQhLztdUOEn/QHTPWgxozxmzLCrvA0gELyuL+7MaQ4U6KTEygWal8upNuH3w4YJLx2e3lG+585B3uEVc52/ondc/mciy6HvW9KeJh5DUzgAFPU4AgQloAeG9stcXrQJW76JPNA+png5zYPlDvZGpDuCvMoQPO4R8NzbuYWfYJsAQaxXuDtVvuaTtkVodGj/S2irb18wUYkhsmJ0BiaJF0lzXXB4Xb0K5Ub+PXqg2TKATjkP4UJStnApPLD47sQ7TpfnMyNuATUKIHSo/ilJ8WbNeiWKx/9L8oBaqEWrM+YRV+9YHfb8AtRoqlxBYvsHzbQw6UYG8O0B/TUpT2UVqPIkgcK/eyijbmFfYs3NDY2IyQRicqnTWrkm1++JRs7d/xkyJald4sOV++PuJuXfynJtBbj8zLxG4du0AwWIypYYhlHSR5adCvBybWqiCwjchmkC2m8o7WL3VqBpSIysglrzpq1xtuaBdxsx0HPkN3ZwcuM+Su8B3P0tDTJoCD5Bgou1oUx3hxEtLPFV8EdaBSopRdaQDIRoH5H1MqDD1jLqet2HTQD3XJnD6FjQdyxBG2hv+pwc57pTeMMLrTJekDQCShRh+wdNgj7J9EQ1Bh7XDfDytD+KxIUfR8uPjvg8A2RXSN9GksTAPzYAb4XQ53auKE4ZTz0DCM71DWVf7IIpnokpOeupG3e+sGITcAX3lfgtMtxNVrZi3Qjxn2DQaF5dG+2rEH1kanfrHW/X67GJUDQXD8Q7eQVWxdHCd5kJYakoe48B/iP0i37oHJW8UqBt6t4PKCdQEow9MAsDZf9I04Y1OQfjO9Wkat1oSokGrNYM3A5iUqRn8Br4kHE6qxY4SkjLlIgbGAGlQgPWvNdixkgExRohpBChxOFLP2t8pElek8KItu4kUbHz0srCer1uNyMtW0UHasUBk8Na5nzZwDy0Xy2UiJwlXAg8q+IuGO1ayOMkJ3baYqMTqe57FxWKG+nLoDi5Q8g6zyFh9lXdKVHDRKsRGbD6ztXDSO9w7I1reUyZw8pTCN7AvFnrnj5swKheqIZ0SqrtgFrSxC0eG9kHoxm0BqH45an/sOnswKfBTWYgafQnmUIL8YgMyUT4OceI814+DijEApvWZg20DSasvUjmueaL+MNr9GhDpVSKAPVLRtdc7DWqAQToba2McUZMgNGoPMLmulYTxr2LGaW4xlrACOekZYDpKFmXkLnvWUGkle7GaMSHdp33ZSUuE1zSIvKEY/DCqjQ1advkPdZk4YKn61vL94SYszEOvRfpKP0/biZPyR1TrR3biTmmIy8hVLf55elrAUythR0SlAViRrh/BfEU0ji/pN8li0LkrM23/iT1lUrEZSt43MF0lI5gs4t7Oe3j2fH5fJegM7IhpM+XBqu7B/mGVgDvNat5NqkDEHm7NrEpfUnmImDJsMFLeKUGFoG6JP/lk2ed+4dBMO4KiQdwb8cRxtezBJJowzYVJWpMWoMdLj0IEqIId3MV07swGLaP4r5XTsCwZI3ALks2/1J63l5OVX7Dd2xcJ+cKw7p4zyKjy53zFk39Ydl1vsQsVKjp6TiJmA/bHZzXPrt8b/eH/UlwPtYWHhuhNLGDcpGQcKyGS5KfjfnJevmoPDw1RZuNBMdFoFZ1XKFQEUHuUxcgbukVKlkEYqMSZvJZNhBjhk8bh5YwH4/aF2J1Yz+sgX3miOQk6mtvFrIzcD2JB4oh5ZdThHfFd3pkdI+q+CcQDk3c34mWjpCIHPqHjFOLWEd7or2I80XrKRIlsT+5rFUB3HVxKzDV65TfSFMpoymx2ixP/jcdK/XXzCgM09kuYlCLL62/eM7H5gy7k6G0AnQ7kGnE4gLzNmIMDGn2pPDhLsH4PcqQf9t0kZEPqOBvlBFvfLR9dq6JAxjcTlY73M7AkqTetwTcscTBy1aeIGXPZE2pyPlsYlVjFwKXI5NZT6PiqyirNOYSKGqbv63JsoaE3HNwwSJhfipeEzXQo0y3y5ZsYFQ4hRIDJzT9KJwNjPbIT3x1/T06FnY7Yc9+vcwKjxpNDlx1Dkd9pii7g+jDRE8VSz8PLEYpVT3h0Jr5txa1usYQqR/R+7hDhU5RWqVjxewM4thrqf9Mm6DIvF0JKXrhux2H1Mu49TtSUKGYuWKHrQ5Y+p0TLqwUNca15psvsoG3a9E5f8Kzf5tgDjUZigRQwWLgJPAaqMIxV/yvNP1dPxoqMP21G1x0VscTKIURAvFKhWRahPbKhYCJeGZE5W8YscGqPG5HgwCCB1JJGS5Xeou+yj78AA5XDDH8RHXrN9hCWB+ad7KC/FQyv9NPqatbObq4/h1uOiem1xxu2y4oez5LKdA9s4o5FzSUENTBwJUZ6tiHazWPhLjqQBrIbMXkK6ydNN1S4rSpLuKLTj1d4bE0kmvt4bzV/BswLOC0BqDfJJj40qWOStqawrtackdBufxNLM4gW556b2GG900UnL/l2lFlq5RBTUzH8iXpAWu33Un4GZjrHhE4mW+2B8N2/F+977JHMlUu4Rd/jhrlQC0lwLMFiWKhTjSl6BUgDuR5h1v8GT5/1D6EIzgtV1AleC3brDJ9GnxCi+g+gYOaiMkawvHt1sSaPZRwpNSN4kaWifUJ+kkHanTM3e94u0JeRXtm7XQD0w1VHmBmTRcJIBTDm5GsLWphWwRnszZ2feJYQX2iWjoJ66tYO9w835wQYaMkz5QTnbSB6e42YVDeFDi/H5DVwfbc1TlVUts7e7LglFB5C0mOwUbIyKaPBw0xX+Vax3ffDA7EgapXRgLRxEHIwoM4ryvefaODzN0H1L7E/gYECuncG7G+rn7qfZdAlXWPtHsp6v8dDTzL/CJE3KT1NELoWEqi8UqWNzW1UEVDQqaU+Oh3e3jxiRm6UXrZ9IWFH543NCjtF+d109FpSZOe4W9aM7//WwaFbETpRGLnLWsc2OxNkELAz59ri5pLILc7rcVEJFGHuO4kvQvifsOLd4LwcJaGbxxRb68xFxSBohMEMwq16QHDi7XI053HLvw+MnvcfBLHrvElo8HFGO9Ohf/WI12okx9S7PYn7cXM1jW3ouxD7jtkfYEiPrdEM61uYOZXcQCGMsp8q/irnAqX5seyB6ZxJFgWH6HfPLcBVsXP3+ReccoJoU17/zqYfYxXuazgTW9UWH0xRTGH016A52wc+glP+snAAcsoaU4yFcJ43k7fb8vo/bVlxwtO4DDzjzq9s
    pipelines:
      - PetClinic
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: tw-jun-20
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
            elastic_profile_id: docker-jdk
            artifacts:
              - test:
                  source: target/surefire-reports
            tasks:
            - exec:
                arguments:
                - clean
                - package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
    - approve-canary:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: manual
        jobs:
          complete-canary:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./complete-canary.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
