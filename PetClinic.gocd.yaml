format_version: 9
environments:
  gcp:
    environment_variables:
      GCLOUD_CLUSTER: devops-workshop-gke
      GCLOUD_ZONE: us-central1-a
      GCLOUD_PROJECT_ID: devops-workshop-123
    secure_variables:
      GCLOUD_SERVICE_KEY: AES:tKi1x1bU/8oTc7qhVLPlVg==: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
    pipelines:
      - PetClinic
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: tw-jun-20
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
            elastic_profile_id: docker-jdk
            artifacts:
            - test:
                source: target/surefire-reports
                destination: test-reports
            tasks:
            - exec:
                arguments:
                - clean
                - package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
          allow_only_on_success: false
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - secret.json
                command: rm
                run_if: passed
    - approve-canary:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: manual
        jobs:
          complete-canary:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./complete-canary.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
